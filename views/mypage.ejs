<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>마이 페이지</title>
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  
  <script src="/mypagejs/favorites.js"></script>
  <script src="/mypagejs/preferredarea.js"></script>
  <script src="/mypagejs/mypagedelete.js"></script>

  <style>
    .section { display: none; }
    .section.active { display: block; }

    /* 메뉴바 */
    .main-menu {
        display: flex;
        justify-content: center;
        gap: 8px;
        background-color: transparent;
        margin-bottom: 20px;
        margin-right: 10px;
    }

    .main-menu a {
        padding: 10px 20px;
        border-radius: 12px;
        background-color: #FFC1A9;
        text-decoration: none;
        color: black;
        font-weight: 500;
        font-size: 14px;
        box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
    }

    /* 사이드바 */
    .sidebar {
        float: left;
        width: 250px;
        height: 520px;
        background: #fff;
        border-right: 1px solid #ccc;
        padding: 20px;
        box-sizing: border-box;
        margin-right: 8px;
        margin-left: 25px;
        border-radius: 10px;
    }

    .sidebar .profile {
        text-align: center;
        margin-bottom: 15px;
    }

    .sidebar .profile img {
        width: 130px;
        height: 130px;
        object-fit: cover;
        border-radius: 50%;
        cursor: pointer;
        margin-top: 30px;
    }

    .sidebar .profile #nicknameDisplay {
        margin-top: 10px;
        font-weight: 700;
        font-size: 16px;
    }

    .sidebar .menu button {
        width: 100%;
        padding: 12px 10px;
        margin-bottom: 10px;
        font-weight: 700;
        font-size: 16px;
        border: none;
        background: #FFC1A9;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        white-space: nowrap;
    }

    .sidebar .menu button.active {
      background-color: #ff986f;
      color: white;
    }

    /* 메인 콘텐츠 */
    .main {
        overflow-y: auto; /* 세로 스크롤 */
        max-height: 600px; /* 화면 높이 내에서 최대 높이 제한 */
        max-width: 1100px;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        padding: 20px 30px 70px 40px;
        margin: 0 auto; /* 화면 가운데 정렬 */
    }

    .section {
        display: none;
    }

    .section.active {
        display: block;
    }

    h2 {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 30px;
    }

    /* 폼 공통 스타일 */
    .form-group {
        margin-bottom: 25px;
    }

    .form-group label {
        display: block;
        font-weight: 700;
        font-size: 18px;
        margin-bottom: 8px;
    }

    .form-group input[type="text"],
    .form-group input[type="password"] {
        width: 100%;
        height: 50px;
        border: 1px solid #000;
        border-radius: 20px;
        padding: 0 20px;
        font-size: 18px;
        box-sizing: border-box;
        box-shadow: 0 4px 4px rgba(0,0,0,0.25);
    }

    /* 주소 검색 */
    .address-search-wrapper {
        display: flex;
        align-items: center;
    }

    .address-search-wrapper input[readonly] {
        flex-grow: 1;
        cursor: pointer;
    }

    .address-search-wrapper button {
        margin-left: 15px;
        padding: 10px 20px;
        font-weight: 700;
        font-size: 14px;
        border: none;
        background: #FFC1A9;
        border-radius: 15px;
        cursor: pointer;
        box-shadow: 0 4px 4px rgba(0,0,0,0.25);
        white-space: nowrap;
    }

    .address-search-wrapper button:hover {
        background: #ff986f;
        color: white;
    }

    .save-btn {
        padding: 15px 30px;
        font-weight: 700;
        font-size: 15px;
        background: #FFC1A9;
        border: 1px solid #000;
        border-radius: 15px;
        cursor: pointer;
        margin-top: 30px;
        display: inline-block;
        box-shadow: 0 4px 4px rgba(0,0,0,0.25);
    }

    /* 즐겨찾기 도서관 리스트 */
    #favoritesList {
        list-style: none;
        padding-left: 0;
        margin-bottom: 20px;
    }

    #favoritesList li {
        padding: 10px 15px;
        border: 1px solid #000;
        border-radius: 10px;
        margin-bottom: 8px;
        background: #fff;
        font-weight: 700;
        font-size: 18px;
    }

    /* 즐겨찾기 추가 input + button */
    .form-inline {
        display: flex;
        gap: 15px;
        margin-top: 15px;
    }

    .form-inline input[type="text"] {
        flex-grow: 1;
        height: 45px;
        border-radius: 15px;
        padding: 0 15px;
        border: 1px solid #ccc;
    }

    .form-inline button {
        white-space: nowrap;
        width: 70px;
        height: 45px;
        font-weight: 700;
        border-radius: 15px;
        background: #FFC1A9;
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 4px rgba(0,0,0,0.25);
    }

    .menu button.active {
        background-color: #ff986f;
        color: white;
    }
  </style>
</head>
<body>
<div class="sidebar">
  <div class="profile">
    <form id="profileForm" action="/mypage/upload-profile-image" method="POST" enctype="multipart/form-data">
      <input type="file" id="profileImage" name="profileImage" accept="image/*" style="display:none;" />
      <img
          id="profilePreview"
          src="<%= user.profileImage || '/mypage/images/default.jpg' %>"
          alt="프로필 이미지"
          style="width: 130px; height: 130px; object-fit: cover; border-radius: 50%; cursor: pointer;"
          title="클릭해서 프로필 이미지 선택"
      />
    </form>
    <p id="nicknameDisplay" style="margin-top: 10px; font-weight: bold; font-size: 23px;">
      <%= user.nickname || '닉네임 없음' %>
    </p>
  </div>

  <div class="menu">
      <button type="button" onclick="showSection('info')">내 정보 수정</button>
      <button type="button" onclick="showSection('preferredAreaSection')">선호지역</button>
      <button type="button" onclick="showSection('favorites')">즐겨찾는 도서관</button>
      <button type="button" onclick="showSection('posts')">작성한 글/댓글</button>
  </div>
</div>

<div class="main">
  <!-- 내 정보 수정 -->
  <div id="info" class="section">
      <form id="updateForm">
          <div>
              <label for="password">비밀번호</label>
              <input type="password" id="password" name="password" />
          </div>
          <div>
              <label for="nickname">닉네임</label>
              <input type="text" id="nickname" name="nickname" value="<%= user.nickname %>" required />
          </div>
          <div>
              <label for="address">주소</label>
              <div class="address-search-wrapper">
                  <input
                      type="text"
                      id="address"
                      name="address"
                      value="<%= user.address %>"
                      readonly
                      placeholder="주소를 검색하세요"
                  />
                  <button type="button" id="searchAddressBtn">검색</button>
              </div>
          </div>
          <button type="submit" class="save-btn" id="saveInfoBtn">저장</button>
      </form>
  </div>
</div>

    <!-- 선호지역 -->
    <form id="preferredForm" onsubmit="savePreferredAddresses(); return false;">
    <section id="preferredAreaSection" class="section">
        <h2>선호지역</h2>

        <% for (let i = 1; i <= 3; i++) { %>
        <div class="form-group">
            <label for="region_level<%= i %>">선호지역 <%= i %></label>
            <div class="address-search-wrapper">
            <input
                type="text"
                id="region_level<%= i %>"
                name="region_level<%= i %>"
                placeholder="주소 검색"
                value="<%= (preferred_areas.find(a => a.region_level === i)?.region_name) || '' %>"
                readonly
            />
            <button type="button" onclick="searchPreferredAddress('region_level<%= i %>')">주소 검색</button>
            </div>
        </div>
        <% } %>

        <button class="save-btn" type="submit">저장</button>
    </section>
    </form>

    <!-- 즐겨찾는 도서관  -->
    <section id="favorites" class="section">
    <h2>즐겨찾는 도서관</h2>
    <ul id="favoritesList">
        <% if (favoriteLibraries && favoriteLibraries.length > 0) { %>
        <% favoriteLibraries.forEach(function(lib) { %>
            <li data-library-id="<%= lib.library_id %>">
            <%= lib.name %> - <%= lib.address %>
            <button class="removeFavoriteBtn" data-library-id="<%= lib.library_id %>">삭제</button>
            </li>
        <% }); %>
        <% } else { %>
        <li>즐겨찾는 도서관이 없습니다.</li>
        <% } %>
    </ul>

    <div class="form-group form-inline">
        <input type="text" id="newFavoriteInput" placeholder="도서관 이름 입력" />
        <button id="addFavoriteBtn" type="button">추가</button>
    </div>
    </section>


<!-- 작성한 글 -->

<!-- 도서 리뷰 -->
    <div class="post-category">
    <h3>📚 도서 리뷰</h3>
    <ul id="bookReviewList">
        <% if(bookReviews && bookReviews.length > 0) { %>
        <% bookReviews.forEach(review => { %>
        <li>
            <a href="/bookReview/post/<%= review.review_id %>"><%= review.title %></a> - 평점: <%= review.rating %>점
            <form action="/userBookReview/<%= review.review_id %>/delete" method="POST" style="display:inline;">
            <button type="submit" onclick="return confirm('정말 삭제할까요?');">삭제</button>
            </form>
        </li>
        <% }) %>
        <% } else { %>
        <li>작성한 도서 리뷰가 없습니다.</li>
        <% } %>
    </ul>
    </div>

    <!-- 도서관 리뷰 -->
    <div class="post-category">
    <h3>🏛️ 도서관 리뷰</h3>
    <ul id="libraryReviewList">
        <% if(libraryReviews && libraryReviews.length > 0) { %>
        <% libraryReviews.forEach(review => { %>
        <li>
            <a href="/libraryReview/<%= review.review_id %>"><%= review.library_name %> 후기</a>
            <form action="/userLibraryReview/<%= review.review_id %>/delete" method="POST" style="display:inline;">
            <button type="submit" onclick="return confirm('정말 삭제할까요?');">삭제</button>
            </form>
        </li>
        <% }) %>
        <% } else { %>
        <li>작성한 도서관 리뷰가 없습니다.</li>
        <% } %>
    </ul>
    </div>

    <!-- 커뮤니티 글 -->
    <div class="post-category">
    <h3>🗣️ 커뮤니티 게시글</h3>
    <ul id="communityPostList">
        <% if(posts && posts.length > 0) { %>
        <% posts.forEach(post => { %>
        <li>
            <a href="/community/communityList/post/<%= post.post_id %>"><%= post.title %></a><br />
            <small><%= new Date(post.created_at).toLocaleString() %></small><br />
            <form action="/userCommunity/post/delete/<%= post.post_id %>" method="POST" style="display:inline;">
            <button type="submit" onclick="return confirm('글을 삭제합니까?');">삭제</button>
            </form>
            <a href="/community/post/<%= post.post_id %>/edit"><button>수정</button></a>
        </li>
        <% }) %>
        <% } else { %>
        <li>작성한 글이 없습니다.</li>
        <% } %>
    </ul>
    </div>

    <!-- 커뮤니티 댓글 -->
    <div class="post-category">
    <h3>💬 커뮤니티 댓글</h3>
    <ul id="communityCommentList">
        <% if(comments && comments.length > 0) { %>
        <% comments.forEach(comment => { %>
        <li>
            <p><%= comment.content %></p>
            <small><%= new Date(comment.created_at).toLocaleString() %></small><br />
            <a href="/community/communityList/post/<%= comment.post_id %>">▶ 해당 글로 이동 (<%= comment.post_title %>)</a><br />
            <form action="/userCommunity/comment/delete/<%= comment.comment_id %>" method="POST" style="display:inline;">
            <button type="submit" onclick="return confirm('댓글을 삭제합니까?');">삭제</button>
            </form>
            <a href="/community/communityList/comment/<%= comment.comment_id %>/edit"><button>수정</button></a>
        </li>
        <% }) %>
        <% } else { %>
        <li>작성한 댓글이 없습니다.</li>
        <% } %>
    </ul>
    </div>
  </div>
<script>
// 마이 페이지 접속 시 내 정보 화면 띄움
    document.addEventListener('DOMContentLoaded', () => {
        showSection('info');
    });

// 메뉴 버튼 누르면 메인 섹션에 띄우는 화면 바꿔보이게
    function showSection(id) {
        document.querySelectorAll('.section').forEach(sec => sec.style.display = 'none');
        const section = document.getElementById(id);
        if (section) section.style.display = 'block';
    }
</script>
</body>
</html>