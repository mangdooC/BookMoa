<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë§ˆì´ í˜ì´ì§€</title>
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  <% const activeTab = typeof tab !== 'undefined' ? tab : 'default'; %>

  <style>
    /* ê¸°ë³¸ ì„¹ì…˜ ìˆ¨ê¸°ê¸° */
    .section {
        display: none;
    }
    .section.active {
        display: block;
    }

    /* ì‚¬ì´ë“œë°” */
    .sidebar {
        float: left;
        width: 250px;
        height: 550px;
        margin: 50px 50px 0 120px;
        padding: 20px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 10px;
        box-sizing: border-box;
        margin-top: 0;
    }

    /* í”„ë¡œí•„ */
    .profile {
    text-align: center;
    margin-bottom: 30px;
    }

    #profilePreview {
        width: 130px;
        height: 130px;
        border-radius: 50%;
        object-fit: cover;
        cursor: pointer;
        margin-top: 30px;
    }

    #nicknameDisplay {
        margin-top: 10px;
        font-weight: 700;
        font-size: 23px;
        white-space: nowrap;
    }

    /* ë©”ë‰´ ë²„íŠ¼ */
    .menu button {
        width: 100%;
        padding: 12px 10px;
        margin-bottom: 10px;
        font-size: 16px;
        font-weight: 700;
        background: #ffc1a9;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .menu button.active {
        background-color: #ff986f;
        color: #fff;
    }

    /* ë©”ì¸ ì½˜í…ì¸  */
    .main {
        margin: 50px 0 0 20px;
        padding: 20px 30px 70px 40px;
        max-width: 900px;
        max-height: 600px;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
    }

    /* ì œëª© */
    h2 {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 30px;
    }

    /* í¼ */
    .form-group {
        margin-bottom: 25px;
    }

    .form-group label {
        display: block;
        margin: 20px 0 8px;
        font-size: 18px;
        font-weight: 700;
    }

    .form-group input[type="text"],
    .form-group input[type="password"] {
        width: 100%;
        height: 50px;
        padding: 0 20px;
        font-size: 18px;
        border: 1px solid #000;
        border-radius: 20px;
        box-sizing: border-box;
    }

    /* ì£¼ì†Œ ê²€ìƒ‰ */
    .address-search-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .address-search-wrapper input[readonly] {
        background: #f5f5f5;
        cursor: pointer;
    }

    .address-search-wrapper button {
        padding: 10px 20px;
        font-weight: 700;
        background: #ffc1a9;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        white-space: nowrap;
    }

    .address-search-wrapper button:hover {
        background-color: #ff986f;
        color: #fff;
    }

    /* ì €ì¥ ë²„íŠ¼ */
    .save-btn {
        background: #ffc1a9;
        border: none;
        padding: 12px 20px;
        font-size: 16px;
        font-weight: 700;
        border-radius: 12px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        }

    .save-btn:hover {
        background-color: #ff986f;
        color: white;
    }

    /* ì´ˆê¸°í™” ë²„íŠ¼ */
    #resetFavoriteBtn, #resetUserBtn {
        background: #8bc34a;
        border: none;
        padding: 12px 20px;
        font-size: 16px;
        font-weight: 700;
        border-radius: 12px;
        cursor: pointer;
        color: white;
        transition: background-color 0.3s ease;
    }

    #resetFavoriteBtn:hover, #resetUserBtn:hover {
        background-color: #689f38;
        color: black;
    }

    /* ì¦ê²¨ì°¾ê¸° */
    #favoritesList {
        list-style: none;
        padding-left: 0;
    }

    #favoritesList li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 700px;
        margin-bottom: 10px;
    }

    .removeFavoriteBtn {
        background: #ff5c5c;
        border: none;
        color: white;
        padding: 5px 10px;
        width: 50px;
        font-weight: 700;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    .removeFavoriteBtn:hover {
        background-color: #ff1f1f;
    }

    /* ì¦ê²¨ì°¾ê¸° ì…ë ¥ */
    #favorites .form-group {
        position: relative;
        width: 700px;
    }

    #newFavoriteInput {
        width: 100%;
        box-sizing: border-box;
    }

    #searchResults {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        width: 700px;
        max-height: 150px;
        overflow-y: auto;
        background: #fff;
        border: 1px solid #ccc;
        z-index: 100;
    }

    /* ì¸ë¼ì¸ í¼ */
    .form-inline {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .form-inline input[type="text"] {
        flex-grow: 1;
        height: 50px;
        padding: 0 20px;
        font-size: 18px;
        border: 1px solid #000;
        border-radius: 20px;
    }

    /* ì¶”ê°€ ë²„íŠ¼ */
    #addFavoriteBtn {
        background: #ffc1a9;
        border: none;
        padding: 12px 20px;
        font-size: 16px;
        font-weight: 700;
        border-radius: 12px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    #addFavoriteBtn:hover {
        background-color: #ff986f;
        color: white;
    }

    /* ê²Œì‹œê¸€, ëŒ“ê¸€ */
    .post-category {
        margin-bottom: 40px;
    }

    .post-category h3 {
        font-size: 24px;
        margin-bottom: 15px;
    }

    .post-category ul {
        list-style: none;
        padding-left: 0;
    }

    .post-category li {
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .post-category li form,
    .post-category li a {
        display: inline-block;
        margin-right: 10px;
    }

    .post-category li button {
        background-color: #ffc1a9;
        border: none;
        padding: 6px 12px;
        font-weight: 700;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .post-category li button:hover {
        background-color: #ff986f;
        color: white;
    }

    .post-category small {
        margin-right: 5px;
        color: #666;
    }

    /* ì¦ê²¨ì°¾ê¸° ì„¹ì…˜ */
    #favorites {
        margin-top: 30px;
    }

    /* ì…ë ¥ í¼ ê·¸ë£¹ */
    #favorites .form-group.form-inline {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        width: 100%;
        margin-bottom: 20px;
    }

    /* ì¦ê²¨ì°¾ê¸° ì…ë ¥ì°½ */
    #newFavoriteInput {
        flex-grow: 1;
        height: 45px;
        padding: 0 20px;
        border-radius: 20px;
        border: 1px solid #000;
        font-size: 16px;
        box-sizing: border-box;
    }

    /* ì¶”ê°€ ë²„íŠ¼ */
    #addFavoriteBtn {
        background-color: #FFC1A9;
        border: none;
        padding: 10px 18px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 15px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        white-space: nowrap;
    }

    #addFavoriteBtn:hover {
        background-color: #ff986f;
        color: white;
    }

    /* ì¦ê²¨ì°¾ê¸° ë¦¬ìŠ¤íŠ¸ */
    #favoritesList {
        list-style: none;
        padding-left: 0;
        margin-top: 10px;
    }

    #favoritesList li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 18px;
        border: 1px solid #ccc;
        border-radius: 12px;
        margin-bottom: 12px;
        background-color: #fff;
        width: 100%;
        box-sizing: border-box;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        font-size: 16px;
        font-weight: 500;
    }

    /* ì‚­ì œ ë²„íŠ¼ */
    .removeFavoriteBtn {
        background-color: #ff5c5c;
        border: none;
        padding: 8px 12px;
        border-radius: 10px;
        color: white;
        cursor: pointer;
        font-weight: 700;
        font-size: 14px;
        transition: background-color 0.3s ease;
    }

    .removeFavoriteBtn:hover {
        background-color: #ff1f1f;
    }

  </style>
</head>
<body>
<div class="sidebar">
  <div class="profile">
    <form id="profileForm" action="/user/upload-profile-image" method="POST" enctype="multipart/form-data">
      <input type="file" id="profileImage" name="profileImage" accept="image/*" style="display:none;" />
      <img
        id="profilePreview"
        src="<%= user.profileImage || '/mypage/images/default.jpg' %>"
        alt="í”„ë¡œí•„ ì´ë¯¸ì§€"
        style="width: 130px; height: 130px; object-fit: cover; border-radius: 50%; cursor: pointer;"
        title="í´ë¦­í•´ì„œ í”„ë¡œí•„ ì´ë¯¸ì§€ ì„ íƒ"
      />
    </form>
    <p id="nicknameDisplay" style="margin-top: 10px; font-weight: bold; font-size: 23px;">
      <%= user.nickname %>ë‹˜
    </p>
  </div>

  <div class="menu">
    <button type="button" onclick="showSection('info')">ë‚´ ì •ë³´ ìˆ˜ì •</button>
    <button type="button" onclick="showSection('preferredArea')">ì„ í˜¸ì§€ì—­</button>
    <button type="button" onclick="showSection('favorites')">ì¦ê²¨ì°¾ëŠ” ë„ì„œê´€</button>
    <button type="button" onclick="showSection('posts')">ì‘ì„±í•œ ê¸€/ëŒ“ê¸€</button>
    <button type="button" id="deleteAccountBtn" style="color: red;">íšŒì› íƒˆí‡´</button>
  </div>
</div>

<div class="main">
  <!-- ë‚´ ì •ë³´ ìˆ˜ì • -->
  <div id="info" class="section">
    <form id="updateForm" action="/user/update?user_id=<%= user.id %>" method="POST">
        <div class="form-group">
         <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
         <input type="password" id="password" name="password" />
         <span id="passwordError" style="display:none; color:red; font-size:0.9em; margin-top:4px;"></span>
        </div>
      <div class="form-group">
        <label for="nickname">ë‹‰ë„¤ì„</label>
        <input type="text" id="nickname" name="nickname" value="<%= user.nickname %>" required />
      </div>
      <div class="form-group">
        <label for="address">ì£¼ì†Œ</label>
        <div class="address-search-wrapper">
          <input
            type="text"
            id="address"
            name="address"
            placeholder="ì£¼ì†Œ ê²€ìƒ‰"
            value="<%= user.address %>"
            readonly
          />
          <button type="button" onclick="searchPreferredAddress('address')">ì£¼ì†Œ ê²€ìƒ‰</button>
        </div>
      </div>
      <button type="button" class="save-btn" id="saveInfoBtn">ì €ì¥</button>
      <button id="resetUserBtn" type="button">ì´ˆê¸°í™”</button>
    </form>
  </div>

  <!-- ì„ í˜¸ì§€ì—­ -->
  <form id="preferredForm" action="/user/preferred?user_id=<%= user.id %>" method="POST" onsubmit="savePreferredAddresses(); return false;">
    <section id="preferredArea" class="section">
      <h2>ì„ í˜¸ì§€ì—­</h2>

      <% for (let i = 1; i <= 3; i++) { %>
        <div class="form-group">
          <label for="region_level<%= i %>">ì„ í˜¸ì§€ì—­ <%= i %></label>
          <div class="address-search-wrapper">
            <input
              type="text"
              id="region_level<%= i %>"
              name="region_level<%= i %>"
              placeholder="ì£¼ì†Œ ê²€ìƒ‰"
              value="<%= (preferred_areas.find(a => a.region_level === i)?.region_name) || '' %>"
              readonly
            />
            <button type="button" onclick="searchPreferredAddress('region_level<%= i %>')">ì£¼ì†Œ ê²€ìƒ‰</button>
          </div>
        </div>
      <% } %>

      <button class="save-btn" type="submit">ì €ì¥</button>
      <button id="resetFavoriteBtn" type="button">ì´ˆê¸°í™”</button>
    </section>
  </form>

    <!-- ì¦ê²¨ì°¾ëŠ” ë„ì„œê´€ -->
    <section id="favorites" class="section">
    <h2>ì¦ê²¨ì°¾ëŠ” ë„ì„œê´€</h2>
    
    <div class="form-group form-inline">
        <input type="text" id="newFavoriteInput" placeholder="ë„ì„œê´€ ì´ë¦„ ì…ë ¥" />
        <button id="addFavoriteBtn" type="button">ì¶”ê°€</button>
    </div>

    <ul id="favoritesList">
        <% if (favorite_libraries && favorite_libraries.length > 0) { %>
        <% favorite_libraries.forEach(function(lib) { %>
        <li data-library-id="<%= lib.lib_code %>">
            <span><%= lib.name %> - <%= lib.address %></span>
            <button class="removeFavoriteBtn" data-library-id="<%= lib.lib_code %>">ì‚­ì œ</button>
        </li>
        <% }); %>
        <% } else { %>
        <li>ì¦ê²¨ì°¾ëŠ” ë„ì„œê´€ì´ ì—†ìŠµë‹ˆë‹¤.</li>
        <% } %>
    </ul>
    </section>

  <!-- ì‘ì„±í•œ ê¸€/ëŒ“ê¸€ -->
<section id="posts" class="section">
    <!-- ë„ì„œ ë¦¬ë·° -->
    <div class="post-category">
      <h3>ğŸ“š ë„ì„œ ë¦¬ë·°</h3>
        <ul id="bookReviewList">
          <% if(bookReviews && bookReviews.length > 0) { %>
            <% bookReviews.forEach(review => { %>
              <li>
                <a href="/bookReview/post/<%= review.review_id %>"><%= review.book_title %></a> - í‰ì : <%= review.rating %>ì 
                <button 
                  data-delete-btn 
                  data-action="/mypage/delete/bookReview/<%= review.review_id %>"
                >ì‚­ì œ</button>
              </li>
            <% }) %>
          <% } else { %>
            <li>ì‘ì„±í•œ ë„ì„œ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
          <% } %>
        </ul>
    </div>

  <!-- ë„ì„œê´€ ë¦¬ë·° -->
    <div class="post-category">
      <h3>ğŸ›ï¸ ë„ì„œê´€ ë¦¬ë·°</h3>
        <ul id="libraryReviewList">
          <% if(library_reviews && library_reviews.length > 0) { %>
            <% library_reviews.forEach(review => { %>
              <li style="margin-bottom: 15px;">
                <a href="/library/libraryReview?name=<%= encodeURIComponent(review.library_name) %>"><%= review.library_name %> í›„ê¸°</a>
                <button 
                  type="button" 
                  data-delete-btn 
                  data-action="/mypage/delete/libraryReview/<%= review.review_id %>"
                  style="margin-left: 10px;"
                >ì‚­ì œ</button>
              </li>
            <% }) %>
          <% } else { %>
            <li>ì‘ì„±í•œ ë„ì„œê´€ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
          <% } %>
        </ul>
    </div>

  <!-- ì»¤ë®¤ë‹ˆí‹° ê¸€ -->
    <div class="post-category">
      <h3>ğŸ—£ï¸ ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œê¸€</h3>
        <ul id="communityPostList">
          <% if(posts && posts.length > 0) { %>
            <% posts.forEach(post => { %>
              <li>
                <a href="/community/post/<%= post.post_id %>"><%= post.title %></a><br />
                <small><%= new Date(post.created_at).toLocaleString() %></small><br />
                <button 
                  data-delete-btn 
                  data-action="/mypage/delete/post/<%= post.post_id %>"
                >ì‚­ì œ</button>
              </li>
            <% }) %>
          <% } else { %>
            <li>ì‘ì„±í•œ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>
          <% } %>
        </ul>
    </div>

  <!-- ì»¤ë®¤ë‹ˆí‹° ëŒ“ê¸€ -->
    <div class="post-category">
      <h3>ğŸ’¬ ì»¤ë®¤ë‹ˆí‹° ëŒ“ê¸€</h3>
        <ul id="communityCommentList">
          <% if (comments && comments.length > 0) { %>
            <% comments.forEach(comment => { %>
              <li>
                <p><%= comment.content %></p>
                <small><%= new Date(comment.created_at).toLocaleString() %></small><br />
                <a href="/community/post/<%= comment.post_id %>">â–¶ í•´ë‹¹ ê¸€ë¡œ ì´ë™</a><br />
                <button data-delete-btn data-action="/mypage/delete/comment/<%= comment.comment_id %>">ì‚­ì œ</button>
              </li>
            <% }) %>
          <% } else { %>
            <li>ì‘ì„±í•œ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>
          <% } %>
        </ul>
    </div>
</section>
</div>

<script src="/mypagejs/favorites.js"></script>
<script src="/mypagejs/preferredarea.js"></script>
<script src="/mypagejs/mypagedelete.js"></script>
<script src="/mypagejs/user.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ì¿¼ë¦¬ìŠ¤íŠ¸ë§ì—ì„œ section íŒŒë¼ë¯¸í„° ë°›ìŒ, ì—†ìœ¼ë©´ ê¸°ë³¸ 'info'
  const params = new URLSearchParams(window.location.search);
  const section = params.get('section') || 'info';
  showSection(section);

  // ë©”ë‰´ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ JSì—ì„œ ì²˜ë¦¬ (onclick ë§ê³ )
  document.querySelectorAll('.sidebar .menu button').forEach(btn => {
    btn.addEventListener('click', () => {
      const onclickAttr = btn.getAttribute('onclick');
      if (!onclickAttr) return; // null ì²´í¬ í•„ìˆ˜

      const match = onclickAttr.match(/showSection\('([^']+)'\)/);
      if (match) {
        showSection(match[1]);
      }
    });
  });

  // íƒˆí‡´ ì²˜ë¦¬ ë²„íŠ¼
  const deleteBtn = document.getElementById('deleteAccountBtn');
  if (deleteBtn) {
    deleteBtn.addEventListener('click', () => {
      if (confirm('ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        fetch('/auth/delete', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include' // ì¿ í‚¤ ê°™ì´ ë³´ë‚´ì¤Œ
        })
        .then(res => {
          if (res.ok) {
            alert('íƒˆí‡´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/'; // íƒˆí‡´ í›„ ë©”ì¸í˜ì´ì§€ë¡œ ê°•ì œ ì´ë™
          } else {
            return res.json().then(data => {
              throw new Error(data.error || 'íƒˆí‡´ ì‹¤íŒ¨');
            });
          }
        })
        .catch(err => {
          alert('íƒˆí‡´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
        });
      }
    });
  }
});

function showSection(sectionId) {
  // ëª¨ë“  section ìˆ¨ê¸°ê¸°
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));

  // ì„ íƒí•œ section ë³´ì´ê¸°
  const targetSection = document.getElementById(sectionId);
  if (targetSection) targetSection.classList.add('active');

  // ë©”ë‰´ ë²„íŠ¼ active í† ê¸€ (null ì²´í¬ í•„ìˆ˜)
  document.querySelectorAll('.sidebar .menu button').forEach(btn => {
    const onclickAttr = btn.getAttribute('onclick');
    btn.classList.toggle('active', onclickAttr && onclickAttr.includes(sectionId));
  });

  // URL ì¿¼ë¦¬ìŠ¤íŠ¸ë§ ë³€ê²½ (ìƒˆë¡œê³ ì¹¨ ì—†ì´)
  const url = new URL(window.location);
  url.searchParams.set('section', sectionId);
  window.history.replaceState({}, '', url);
}
</script>
</body>
</html>