<!-- signUp.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>회원가입 페이지</title>
  <link rel="stylesheet" href="/mypage/css/signUp.css" />
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>
<body>
  <div class="logo"></div>
  <div class="signup-wrapper">
    <h1>회원가입</h1>
    <form id="registerForm">
      <div class="form-group">
        <label for="user_id">아이디</label>
        <input
          type="text"
          id="user_id"
          name="user_id"
          placeholder="아이디 (영어, 숫자만)"
          required
        />
        <br />
        <small
          id="user_id_error"
          style="color: red; display: none;"
          >영어와 숫자만 입력 가능</small
        >
      </div>

      <div class="form-group">
        <label for="password">비밀번호</label>
        <input
          type="password"
          id="password"
          name="password"
          placeholder="비밀번호"
          required
        />
      </div>

      <div class="form-group">
        <label for="nickname">닉네임</label>
        <input
          type="text"
          id="nickname"
          name="nickname"
          placeholder="닉네임"
          required
        />
      </div>

      <div class="form-group">
        <label for="address">주소</label>
        <div class="address-wrapper">
          <input
            type="text"
            readonly
            id="address"
            name="address"
            placeholder="주소를 입력하세요"
          />
          <button type="button" class="address-btn" onclick="openAddressSearch()">
            주소 검색
          </button>
        </div>
      </div>

      <button type="submit" class="submit-btn">가입하기</button>
    </form>
  </div>

  <script>
    function openAddressSearch() {
      new daum.Postcode({
        oncomplete: function (data) {
          document.getElementById("address").value = data.roadAddress;
        },
      }).open();
    }

    const userIdInput = document.getElementById("user_id");
    const userIdError = document.getElementById("user_id_error");

    userIdInput.addEventListener("input", () => {
      const value = userIdInput.value;
      const valid = /^[a-zA-Z0-9]*$/.test(value);

      if (!valid) {
        userIdError.style.display = "block";
        userIdInput.value = value.replace(/[^a-zA-Z0-9]/g, "");
      } else {
        userIdError.style.display = "none";
      }
    });

    const form = document.getElementById("registerForm");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const user_id = form.user_id.value;
      const password = form.password.value;
      const nickname = form.nickname.value;
      const address = form.address.value;

      if (!user_id || !password || !nickname || !address) {
        alert("필수 입력란을 모두 채워주세요");
        return;
      }

      try {
        const res = await fetch("/api/auth/register", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id, password, nickname, address }),
        });

        const data = await res.json();

        if (res.ok) {
          alert(data.message || "회원가입 성공!");
          window.location.href = "/";
        } else {
          alert("에러: " + (data.error || "알 수 없는 에러"));
        }
      } catch (err) {
        alert("서버 에러 발생");
        console.error(err);
      }
    });
  </script>
</body>
</html>
